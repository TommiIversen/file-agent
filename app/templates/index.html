<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Transfer Agent - Real-time Monitor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js CDN -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Main background gradient */
        .gradientHolder {
            background: radial-gradient(ellipse at center, rgb(222, 67, 202) 0%, rgba(20, 25, 44, 0.96) 0%, rgba(10, 14, 24, 0.96) 100%);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
        }
        
        .progress-animation {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
            background-size: 200% 100%;
            animation: progress-shine 2s infinite;
        }
        
        @keyframes progress-shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
<body class="gradientHolder min-h-screen" 
      x-data="fileTransferMonitor()" 
      x-init="connect()">
    
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header with Status -->
        <div class="bg-gray-800 bg-opacity-80 rounded-lg shadow-lg p-6 mb-4 text-white">
            <div class="flex justify-between items-start mb-4">
                <h1 class="text-3xl font-bold">File Transfer Agent</h1>
                
                <div class="flex items-center space-x-6">
                    <!-- Connection Status -->
                    <div class="flex items-center">
                        <div class="status-indicator rounded-full mr-2"
                             :class="{
                                 'bg-green-500': connectionStatus === 'connected',
                                 'bg-red-500': connectionStatus === 'disconnected', 
                                 'bg-yellow-500': connectionStatus === 'connecting'
                             }"></div>
                        <span x-text="connectionText" class="text-sm"></span>
                    </div>
                    
                    <div class="text-xs text-gray-300" x-text="lastUpdate"></div>
                </div>
            </div>
            
            <!-- Storage Status Panel -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
                <!-- Source Storage -->
                <div class="bg-gray-700 bg-opacity-60 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold flex items-center">
                            üìÅ Source Storage
                        </h3>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2"
                                 :class="{
                                     'bg-green-500': storageInfo.source?.status === 'OK',
                                     'bg-yellow-500': storageInfo.source?.status === 'WARNING',
                                     'bg-red-500': storageInfo.source?.status === 'ERROR' || storageInfo.source?.status === 'CRITICAL',
                                     'bg-gray-500': !storageInfo.source
                                 }"></div>
                            <span class="text-sm font-medium"
                                  :class="{
                                      'text-green-400': storageInfo.source?.status === 'OK',
                                      'text-yellow-400': storageInfo.source?.status === 'WARNING', 
                                      'text-red-400': storageInfo.source?.status === 'ERROR' || storageInfo.source?.status === 'CRITICAL',
                                      'text-gray-400': !storageInfo.source
                                  }"
                                  x-text="storageInfo.source?.status || 'Unknown'"></span>
                        </div>
                    </div>
                    
                    <template x-if="storageInfo.source">
                        <div class="space-y-2">
                            <!-- Storage Bar -->
                            <div class="w-full bg-gray-600 rounded-lg h-4 overflow-hidden">
                                <div class="h-full transition-all duration-500"
                                     :style="`width: ${((storageInfo.source.total_space_gb - storageInfo.source.free_space_gb) / storageInfo.source.total_space_gb * 100)}%`"
                                     :class="{
                                         'bg-green-500': storageInfo.source.status === 'OK',
                                         'bg-yellow-500': storageInfo.source.status === 'WARNING',
                                         'bg-red-500': storageInfo.source.status === 'ERROR' || storageInfo.source.status === 'CRITICAL'
                                     }"></div>
                            </div>
                            
                            <!-- Storage Details -->
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Ledig: <strong class="text-white" x-text="`${storageInfo.source.free_space_gb.toFixed(1)} GB`"></strong></span>
                                <span class="text-gray-300">Total: <strong class="text-white" x-text="`${storageInfo.source.total_space_gb.toFixed(1)} GB`"></strong></span>
                            </div>
                            
                            <!-- Access Status -->
                            <div class="flex space-x-4 text-xs">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1"
                                         :class="storageInfo.source.is_accessible ? 'bg-green-500' : 'bg-red-500'"></div>
                                    <span :class="storageInfo.source.is_accessible ? 'text-green-400' : 'text-red-400'">
                                        <span x-text="storageInfo.source.is_accessible ? 'Tilg√¶ngelig' : 'Utilg√¶ngelig'"></span>
                                    </span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1"
                                         :class="storageInfo.source.has_write_access ? 'bg-green-500' : 'bg-red-500'"></div>
                                    <span :class="storageInfo.source.has_write_access ? 'text-green-400' : 'text-red-400'">
                                        <span x-text="storageInfo.source.has_write_access ? 'Skrivbar' : 'Skrivebeskyttet'"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="!storageInfo.source">
                        <div class="text-gray-400 text-sm">Indl√¶ser storage information...</div>
                    </template>
                </div>
                
                <!-- Destination Storage -->
                <div class="bg-gray-700 bg-opacity-60 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold flex items-center">
                            üéØ Destination Storage
                        </h3>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2"
                                 :class="{
                                     'bg-green-500': storageInfo.destination?.status === 'OK',
                                     'bg-yellow-500': storageInfo.destination?.status === 'WARNING',
                                     'bg-red-500': storageInfo.destination?.status === 'ERROR' || storageInfo.destination?.status === 'CRITICAL',
                                     'bg-gray-500': !storageInfo.destination
                                 }"></div>
                            <span class="text-sm font-medium"
                                  :class="{
                                      'text-green-400': storageInfo.destination?.status === 'OK',
                                      'text-yellow-400': storageInfo.destination?.status === 'WARNING',
                                      'text-red-400': storageInfo.destination?.status === 'ERROR' || storageInfo.destination?.status === 'CRITICAL',
                                      'text-gray-400': !storageInfo.destination
                                  }"
                                  x-text="storageInfo.destination?.status || 'Unknown'"></span>
                        </div>
                    </div>
                    
                    <template x-if="storageInfo.destination">
                        <div class="space-y-2">
                            <!-- Storage Bar -->
                            <div class="w-full bg-gray-600 rounded-lg h-4 overflow-hidden">
                                <div class="h-full transition-all duration-500"
                                     :style="`width: ${((storageInfo.destination.total_space_gb - storageInfo.destination.free_space_gb) / storageInfo.destination.total_space_gb * 100)}%`"
                                     :class="{
                                         'bg-green-500': storageInfo.destination.status === 'OK',
                                         'bg-yellow-500': storageInfo.destination.status === 'WARNING',
                                         'bg-red-500': storageInfo.destination.status === 'ERROR' || storageInfo.destination.status === 'CRITICAL'
                                     }"></div>
                            </div>
                            
                            <!-- Storage Details -->
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Ledig: <strong class="text-white" x-text="`${storageInfo.destination.free_space_gb.toFixed(1)} GB`"></strong></span>
                                <span class="text-gray-300">Total: <strong class="text-white" x-text="`${storageInfo.destination.total_space_gb.toFixed(1)} GB`"></strong></span>
                            </div>
                            
                            <!-- Access Status -->
                            <div class="flex space-x-4 text-xs">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1"
                                         :class="storageInfo.destination.is_accessible ? 'bg-green-500' : 'bg-red-500'"></div>
                                    <span :class="storageInfo.destination.is_accessible ? 'text-green-400' : 'text-red-400'">
                                        <span x-text="storageInfo.destination.is_accessible ? 'Tilg√¶ngelig' : 'Utilg√¶ngelig'"></span>
                                    </span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-1"
                                         :class="storageInfo.destination.has_write_access ? 'bg-green-500' : 'bg-red-500'"></div>
                                    <span :class="storageInfo.destination.has_write_access ? 'text-green-400' : 'text-red-400'">
                                        <span x-text="storageInfo.destination.has_write_access ? 'Skrivbar' : 'Skrivebeskyttet'"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="!storageInfo.destination">
                        <div class="text-gray-400 text-sm">Indl√¶ser storage information...</div>
                    </template>
                </div>
            </div>
            
            <!-- File Statistics -->
            <div class="flex justify-center">
                <div class="flex space-x-6 text-sm bg-gray-700 bg-opacity-40 rounded-lg px-4 py-2">
                    <span class="text-blue-300">Total: <strong x-text="statistics.totalFiles">0</strong></span>
                    <span class="text-yellow-300">Aktive: <strong x-text="statistics.activeFiles">0</strong></span>
                    <span class="text-green-300">F√¶rdige: <strong x-text="statistics.completedFiles">0</strong></span>
                    <span class="text-red-300">Fejlede: <strong x-text="statistics.failedFiles">0</strong></span>
                </div>
            </div>
        </div>

        <!-- Files List -->
        <div class="space-y-2">
            <!-- Sort Options -->
            <div class="bg-gray-800 bg-opacity-60 rounded-lg p-3 mb-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-white">üìÅ Filer</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-300 text-sm">Sorter efter:</span>
                        <select x-model="sortBy" class="bg-gray-700 text-white text-sm rounded px-3 py-1 border border-gray-600">
                            <option value="activity">Seneste aktivitet</option>
                            <option value="discovered">Opdaget tidspunkt</option>
                            <option value="started">Startet tidspunkt</option>
                            <option value="completed">F√¶rdig tidspunkt</option>
                            <option value="filename">Filnavn</option>
                            <option value="size">Filst√∏rrelse</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <template x-for="file in allFiles" :key="file.file_path">
                <!-- File Card Component -->
                <div class="grid p-2 m-2 items-center shadow-lg md:m-1 rounded-lg overflow-hidden md:grid-cols-6 sm:grid-cols-2 gap-x-1 hover:bg-gray-900 bg-gray-800 text-gray-400 text-sm font-medium">
                    
                    <!-- File Name (spans 2 columns) -->
                    <div class="md:col-span-2 truncate col-span-2">
                        <div class="capitalize md:text-sm text-xl font-extrabold truncate text-white"
                             x-text="file.file_path.split(/[/\\]/).pop()">
                        </div>
                    </div>

                    <!-- File Size -->
                    <div class="truncate md:order-none order-2">
                        St√∏rrelse: <span class="text-white" x-text="`${file.file_size_mb} MB`"></span>
                    </div>

                    <!-- Discovered Time -->
                    <div class="md:order-none order-3">
                        <div class="truncate">
                            Opdaget: <span class="text-white" x-text="formatTime(file.discovered_at)"></span>
                        </div>
                    </div>

                    <!-- Retry Count -->
                    <div class="md:block hidden">
                        <span class="text-gray-300">Retry: </span>
                        <span class="text-white font-bold" x-text="file.retry_count"></span>
                    </div>

                    <!-- Progress Bar (spans 2 columns) -->
                    <div class="md:col-span-2 col-span-1 md:order-none order-4">
                        <div class="w-full bg-gray-700 rounded overflow-hidden">
                            <div class="py-1 text-xs text-center rounded text-white transition-all duration-500 ease-out"
                                 :style="getProgressWidth(file)"
                                 :class="getProgressColor(file)"
                                 x-text="getProgressText(file)">
                            </div>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div class="md:order-none order-7">
                        <div class="w-4/6">
                            <div class="text-green-100 truncate text-center py-1 px-3 rounded-full text-xs font-bold"
                                 :class="{
                                     'bg-blue-600': file.status === 'Discovered',
                                     'bg-green-600': file.status === 'Ready',
                                     'bg-yellow-600': file.status === 'InQueue',
                                     'bg-blue-700': file.status === 'Copying',
                                     'bg-green-700': file.status === 'Completed',
                                     'bg-red-600': file.status === 'Failed'
                                 }"
                                 x-text="file.status">
                            </div>
                        </div>
                    </div>

                    <!-- Started Time -->
                    <div class="md:order-none order-3">
                        <div class="truncate">
                            Startet: <span class="text-green-300" x-text="file.started_copying_at ? formatTime(file.started_copying_at) : '-'"></span>
                        </div>
                    </div>

                    <!-- Completed Time -->
                    <div class="md:order-none order-5">
                        <div class="truncate">
                            F√¶rdig: <span class="text-blue-300" x-text="file.completed_at ? formatTime(file.completed_at) : '-'"></span>
                        </div>
                    </div>

                    <!-- Error Message (full width if present) -->
                    <div x-show="file.error_message" class="md:col-span-6 col-span-2 mt-2 p-2 bg-red-900 bg-opacity-50 rounded border border-red-600">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-red-200 text-xs" x-text="file.error_message"></span>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Empty State -->
            <div x-show="allFiles.length === 0" class="text-center py-12">
                <div class="text-gray-300 text-lg bg-gray-800 bg-opacity-60 rounded-lg p-8">
                    <div class="text-4xl mb-4">üìÅ</div>
                    Ingen filer fundet
                </div>
            </div>
        </div>
    </div>

    <script>
        function fileTransferMonitor() {
            return {
                // Data
                socket: null,
                files: new Map(),
                reconnectAttempts: 0,
                maxReconnectAttempts: 5,
                reconnectDelay: 1000,
                connectionStatus: 'connecting',
                connectionText: 'Forbinder til server...',
                lastUpdate: 'Indl√¶ser...',
                sortBy: 'discovered', // Default sort method - newest discovered files first
                statistics: {
                    totalFiles: 0,
                    activeFiles: 0,
                    completedFiles: 0,
                    failedFiles: 0
                },
                storageInfo: {
                    source: null,
                    destination: null,
                    overall_status: 'Unknown'
                },

                // Computed - Show all files sorted by selected method
                get allFiles() {
                    const files = Array.from(this.files.values());
                    
                    return files.sort((a, b) => {
                        switch (this.sortBy) {
                            case 'activity':
                                // Prioriter efter mest relevante tidspunkt baseret p√• status
                                const getRelevantTime = (file) => {
                                    if (file.completed_at) return new Date(file.completed_at);
                                    if (file.started_copying_at) return new Date(file.started_copying_at);
                                    return new Date(file.discovered_at || 0);
                                };
                                return getRelevantTime(b) - getRelevantTime(a);
                                
                            case 'discovered':
                                const aDiscovered = new Date(a.discovered_at || 0);
                                const bDiscovered = new Date(b.discovered_at || 0);
                                return bDiscovered - aDiscovered;
                                
                            case 'started':
                                const aStarted = a.started_copying_at ? new Date(a.started_copying_at) : new Date(0);
                                const bStarted = b.started_copying_at ? new Date(b.started_copying_at) : new Date(0);
                                return bStarted - aStarted;
                                
                            case 'completed':
                                const aCompleted = a.completed_at ? new Date(a.completed_at) : new Date(0);
                                const bCompleted = b.completed_at ? new Date(b.completed_at) : new Date(0);
                                return bCompleted - aCompleted;
                                
                            case 'filename':
                                const aName = a.file_path.split(/[/\\]/).pop().toLowerCase();
                                const bName = b.file_path.split(/[/\\]/).pop().toLowerCase();
                                return aName.localeCompare(bName);
                                
                            case 'size':
                                return (b.file_size || 0) - (a.file_size || 0);
                                
                            default:
                                return 0;
                        }
                    });
                },

                // Methods
                connect() {
                    try {
                        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        const wsUrl = `${protocol}//${window.location.host}/api/ws/live`;
                        
                        this.socket = new WebSocket(wsUrl);
                        this.setupSocketHandlers();
                        
                    } catch (error) {
                        console.error('WebSocket connection error:', error);
                        this.handleDisconnection();
                    }
                },

                setupSocketHandlers() {
                    this.socket.onopen = () => {
                        console.log('WebSocket connected');
                        this.updateConnectionStatus('connected', 'Forbundet til server');
                        this.reconnectAttempts = 0;
                        
                        // Load initial storage data when connected
                        this.loadStorageData();
                    };
                    
                    this.socket.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };
                    
                    this.socket.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.handleDisconnection();
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.handleDisconnection();
                    };
                },

                handleMessage(message) {
                    this.updateLastUpdate();
                    
                    switch (message.type) {
                        case 'initial_state':
                            this.handleInitialState(message.data);
                            break;
                        case 'file_update':
                            this.handleFileUpdate(message.data);
                            break;
                        case 'statistics_update':
                            this.updateStatistics(message.data.statistics);
                            break;
                        case 'storage_update':
                            this.handleStorageUpdate(message.data);
                            break;
                    }
                },

                handleInitialState(data) {
                    console.log('Received initial state:', data);
                    
                    // Update files
                    this.files.clear();
                    data.files.forEach(file => {
                        this.files.set(file.file_path, file);
                    });
                    
                    // Update statistics
                    this.updateStatistics(data.statistics);
                },

                handleFileUpdate(data) {
                    console.log('File update:', data);
                    
                    // Update or add file
                    this.files.set(data.file_path, data.file);
                    
                    // Update statistics from files
                    this.updateStatisticsFromFiles();
                },

                updateStatistics(stats) {
                    if (stats) {
                        this.statistics.totalFiles = stats.total_files || 0;
                        this.statistics.activeFiles = stats.active_files || 0;
                        this.statistics.completedFiles = stats.completed_files || 0;
                        this.statistics.failedFiles = stats.failed_files || 0;
                    }
                },

                updateStatisticsFromFiles() {
                    const stats = {
                        total: this.files.size,
                        active: 0,
                        completed: 0,
                        failed: 0
                    };
                    
                    this.files.forEach(file => {
                        switch (file.status) {
                            case 'Completed':
                                stats.completed++;
                                break;
                            case 'Failed':
                                stats.failed++;
                                break;
                            default:
                                stats.active++;
                        }
                    });
                    
                    this.statistics.totalFiles = stats.total;
                    this.statistics.activeFiles = stats.active;
                    this.statistics.completedFiles = stats.completed;
                    this.statistics.failedFiles = stats.failed;
                },

                handleStorageUpdate(data) {
                    console.log('Storage update:', data);
                    
                    // Update storage info based on storage type
                    if (data.storage_type === 'source') {
                        this.storageInfo.source = data.storage_info;
                    } else if (data.storage_type === 'destination') {
                        this.storageInfo.destination = data.storage_info;
                    }
                    
                    // Update overall status
                    this.updateOverallStorageStatus();
                },

                async loadStorageData() {
                    try {
                        const response = await fetch('/api/storage');
                        if (response.ok) {
                            const data = await response.json();
                            this.storageInfo.source = data.source;
                            this.storageInfo.destination = data.destination;
                            this.storageInfo.overall_status = data.overall_status;
                            console.log('Loaded initial storage data:', data);
                        } else {
                            console.error('Failed to load storage data:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error loading storage data:', error);
                    }
                },

                updateOverallStorageStatus() {
                    const sourceStatus = this.storageInfo.source?.status;
                    const destStatus = this.storageInfo.destination?.status;
                    
                    // Priority: CRITICAL > ERROR > WARNING > OK
                    const priorities = {
                        'CRITICAL': 4,
                        'ERROR': 3,
                        'WARNING': 2,
                        'OK': 1
                    };
                    
                    const sourcePriority = priorities[sourceStatus] || 0;
                    const destPriority = priorities[destStatus] || 0;
                    
                    if (sourcePriority >= destPriority) {
                        this.storageInfo.overall_status = sourceStatus || 'Unknown';
                    } else {
                        this.storageInfo.overall_status = destStatus || 'Unknown';
                    }
                },

                updateConnectionStatus(status, text) {
                    this.connectionStatus = status;
                    this.connectionText = text;
                },

                updateLastUpdate() {
                    const now = new Date().toLocaleTimeString('da-DK');
                    this.lastUpdate = `Sidst opdateret: ${now}`;
                },

                handleDisconnection() {
                    this.updateConnectionStatus('disconnected', 'Forbindelse afbrudt');
                    
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        this.updateConnectionStatus('connecting', `Pr√∏ver at forbinde igen... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                        
                        setTimeout(() => {
                            this.connect();
                        }, this.reconnectDelay * this.reconnectAttempts);
                    } else {
                        this.updateConnectionStatus('disconnected', 'Kunne ikke forbinde - genindl√¶s siden');
                    }
                },

                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    return new Date(timestamp).toLocaleTimeString('da-DK');
                },

                getProgressWidth(file) {
                    switch (file.status) {
                        case 'Discovered':
                        case 'Ready':
                        case 'InQueue':
                            return 'width: 0%';
                        case 'Copying':
                            return `width: ${file.copy_progress || 0}%`;
                        case 'Completed':
                            return 'width: 100%';
                        case 'Failed':
                            return 'width: 100%';
                        default:
                            return 'width: 0%';
                    }
                },

                getProgressColor(file) {
                    switch (file.status) {
                        case 'Discovered':
                        case 'Ready':
                        case 'InQueue':
                            return 'bg-gray-600';
                        case 'Copying':
                            return 'bg-blue-600';
                        case 'Completed':
                            return 'bg-green-600';
                        case 'Failed':
                            return 'bg-red-600';
                        default:
                            return 'bg-gray-600';
                    }
                },

                getProgressText(file) {
                    switch (file.status) {
                        case 'Discovered':
                        case 'Ready':
                        case 'InQueue':
                            return '0%';
                        case 'Copying':
                            return `${(file.copy_progress || 0).toFixed(1)}%`;
                        case 'Completed':
                            return '100%';
                        case 'Failed':
                            return '0%';
                        default:
                            return '0%';
                    }
                }
            }
        }
    </script>
</body>
</html>